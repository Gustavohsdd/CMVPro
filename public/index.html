<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CMVPro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --azul-700: #1d4ed8; --azul-600: #2563eb; --azul-50:  #eff6ff;
    }
    html, body { height: 100%; }
    body { font-family: "Inter", system-ui, sans-serif; background: var(--azul-50); }
    .layout { min-height: 100vh; display: flex; }
    @media (max-width: 768px) { .layout { flex-direction: column; } aside  { width: 100% !important; height: auto !important; } }
    main::-webkit-scrollbar { width: 8px; }
    main::-webkit-scrollbar-thumb { background-color: #60a5fa; border-radius: 4px; }
    main::-webkit-scrollbar-track { background-color: #e5efff; }
    .menu-item.active { background-color: var(--azul-600); color: #fff; font-weight: 600; }
    .modal-overlay { display: none; position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.7); z-index: 50; justify-content: center; align-items: center; padding: 1rem; }
    .modal-content { background-color: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); width: 100%; max-width: 56rem; max-height: 90vh; overflow-y: auto; }
  </style>
</head>
<body class="text-gray-800">

  <div id="login-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-2xl shadow-xl text-center">
      <h2 class="text-2xl font-bold mb-2 text-gray-800">Bem-vindo ao CMVPro</h2>
      <p class="text-gray-600 mb-6">Fa√ßa login para continuar.</p>
      <button id="login-button" class="bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-700 transition">Entrar com Google</button>
    </div>
  </div>

  <div class="layout">
    <aside class="w-64 bg-[color:var(--azul-700)] text-white p-6 space-y-6 shadow-lg">
      <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold tracking-tight">CMVPro</h1>
        <div id="user-info" class="hidden items-center">
          <button id="logout-button" class="text-sm text-white/70 hover:text-white">Sair</button>
        </div>
      </div>
      <nav>
        <ul class="space-y-2">
          <li><a id="nav-receitas" href="#receitas" class="menu-item block px-4 py-2.5 rounded-lg hover:bg-[color:var(--azul-600)] transition">Receitas</a></li>
          <li><a id="nav-insumos" href="#insumos" class="menu-item block px-4 py-2.5 rounded-lg hover:bg-[color:var(--azul-600)] transition">Insumos</a></li>
        </ul>
      </nav>
      <div class="pt-4 border-t border-white/10 text-sm text-white/80">
        <p>Vers√£o inicial ‚Ä¢ Estilos base prontos</p>
      </div>
    </aside>
    <main id="app" class="flex-1 p-6 md:p-10 overflow-y-auto"></main>
  </div>

  <div id="receita-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="flex justify-between items-start mb-4">
          <h3 class="text-2xl font-bold text-gray-800" id="modal-nome-produto"></h3>
          <button onclick="public_receitas_fecharModalReceita()" class="text-gray-400 hover:text-gray-700 text-3xl leading-none">&times;</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-center">
        <div class="bg-gray-100 p-3 rounded-lg"><label class="text-sm font-semibold text-gray-600">Rendimento KG</label><p class="text-xl font-bold text-gray-900" id="modal-rendimento-kg"></p></div>
        <div class="bg-gray-100 p-3 rounded-lg"><label class="text-sm font-semibold text-gray-600">Rendimento UN</label><p class="text-xl font-bold text-gray-900" id="modal-rendimento-un"></p></div>
        <div class="bg-gray-100 p-3 rounded-lg"><label class="text-sm font-semibold text-gray-600">Perda</label><p class="text-xl font-bold text-gray-900" id="modal-perda"></p></div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="md:col-span-2">
          <h4 class="font-semibold text-lg mb-2">Insumos</h4>
          <div class="border rounded-lg overflow-hidden max-h-64 overflow-y-auto"><table class="min-w-full text-left"><thead class="bg-gray-50 sticky top-0"><tr><th class="px-4 py-2 text-sm font-semibold text-gray-600">Insumo</th><th class="px-4 py-2 text-sm font-semibold text-gray-600">Quantidade</th><th class="px-4 py-2 text-sm font-semibold text-gray-600">Pre√ßo Unit.</th><th class="px-4 py-2 text-sm font-semibold text-gray-600">Valor Usado</th></tr></thead><tbody id="modal-insumos-tbody" class="divide-y divide-gray-200"></tbody></table></div>
        </div>
        <div class="md:col-span-1 space-y-2 text-center">
          <div class="bg-gray-100 p-2 rounded-lg"><label class="text-xs font-semibold text-gray-500">Medida de Venda</label><p id="modal-medida-venda" class="text-lg font-bold text-gray-800">UN</p></div>
          <div class="bg-yellow-100 p-2 rounded-lg border border-yellow-300"><label class="text-xs font-semibold text-yellow-800">Pre√ßo de Venda</label><p id="modal-preco-venda" class="text-xl font-bold text-yellow-900"></p></div>
          <div class="bg-gray-200 p-2 rounded-lg"><label class="text-xs font-semibold text-gray-500">Pre√ßo Sugerido</label><p id="modal-preco-sugerido" class="text-lg font-bold text-gray-800"></p></div>
          <div class="bg-red-700 text-white p-2 rounded-lg"><label class="text-xs font-semibold opacity-80">Markup</label><p id="modal-markup" class="text-lg font-bold"></p></div>
          <div class="bg-red-800 text-white p-2 rounded-lg"><label class="text-xs font-semibold opacity-80">CMV</label><p id="modal-cmv" class="text-lg font-bold"></p></div>
          <div class="bg-gray-100 p-2 rounded-lg"><label class="text-xs font-semibold text-gray-500">C. Insumos</label><p id="modal-custo-insumos" class="text-lg font-bold text-gray-800"></p></div>
          <div class="bg-gray-100 p-2 rounded-lg"><label class="text-xs font-semibold text-gray-500">Outros Custos</label><p id="modal-outros-custos" class="text-lg font-bold text-gray-800"></p></div>
          <div class="bg-gray-100 p-2 rounded-lg"><label class="text-xs font-semibold text-gray-500">Custo/KG</label><p id="modal-custo-kg" class="text-lg font-bold text-gray-800"></p></div>
          <div class="bg-gray-100 p-2 rounded-lg"><label class="text-xs font-semibold text-gray-500">Custo/UN</label><p id="modal-custo-un" class="text-lg font-bold text-gray-800"></p></div>
        </div>
      </div>
      <div class="mt-6 flex justify-end gap-3">
        <button onclick="public_receitas_fecharModalReceita()" class="px-6 py-2 rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300 font-semibold">Cancelar</button>
        <button class="px-6 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 font-semibold">Salvar</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-functions-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAK2fYpIOwetW6xOQHApuSb3WTyjJlyFi8",
      authDomain: "controle-de-cmv-pro.firebaseapp.com",
      projectId: "controle-de-cmv-pro",
      storageBucket: "controle-de-cmv-pro.firebasestorage.app",
      messagingSenderId: "762165281549",
      appId: "1:762165281549:web:f485d42854b74aa680e644"
    };

    // INICIALIZA√á√ÉO GLOBAL
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const functions = firebase.functions();

    if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
      try {
        db.useEmulator('127.0.0.1', 8080);
        functions.useEmulator('127.0.0.1', 5001);
        console.log('üîå Conectado aos Emuladores.');
      } catch (e) { console.warn('N√£o foi poss√≠vel conectar aos Emuladores:', e); }
    }

    // L√ìGICA DE AUTENTICA√á√ÉO E ROTEAMENTO
    const loginOverlay = document.getElementById("login-overlay");
    const loginButton = document.getElementById("login-button");
    const logoutButton = document.getElementById("logout-button");
    const userInfo = document.getElementById("user-info");
    const appContainer = document.getElementById("app");
    const receitaModal = document.getElementById("receita-modal");

    loginButton.addEventListener("click", () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(error => console.error("Erro no login:", error));
    });

    logoutButton.addEventListener("click", () => auth.signOut());

    auth.onAuthStateChanged(user => {
      if (user) {
        loginOverlay.style.display = "none";
        userInfo.classList.remove("hidden");
        // Inicia o roteador quando o usu√°rio est√° logado
        public_index_iniciarRoteador();
      } else {
        loginOverlay.style.display = "flex";
        userInfo.classList.add("hidden");
        appContainer.innerHTML = '';
      }
    });
    
    // Fun√ß√£o para carregar um script dinamicamente
    function public_index_carregarScript(url) {
        // Remove script antigo se existir
        const scriptAntigo = document.getElementById('pagina-script');
        if (scriptAntigo) {
            scriptAntigo.remove();
        }
        
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.id = 'pagina-script';
            script.src = url;
            script.onload = resolve;
            script.onerror = reject;
            document.body.appendChild(script);
        });
    }

    // ROTEADOR PRINCIPAL
    async function public_index_rotear() {
        const hash = window.location.hash.substring(1) || 'receitas'; // Padr√£o para receitas
        
        document.querySelectorAll(".menu-item").forEach(a => a.classList.remove("active"));
        const linkAtivo = document.getElementById(`nav-${hash}`);
        if (linkAtivo) {
            linkAtivo.classList.add("active");
        }

        try {
            await public_index_carregarScript(`${hash}.js`);
        } catch (error) {
            console.error(`Erro ao carregar o script para a p√°gina: ${hash}`, error);
            appContainer.innerHTML = `<p class="text-red-500">Erro ao carregar a p√°gina ${hash}.</p>`;
        }
    }

    function public_index_iniciarRoteador() {
        window.addEventListener('hashchange', public_index_rotear);
        public_index_rotear(); // Carrega a p√°gina inicial baseada no hash ou padr√£o
        
        // Adiciona os eventos de clique nos links do menu para usar o hash
        document.querySelectorAll('aside nav a').forEach(link => {
            link.onclick = (e) => {
                e.preventDefault();
                const page = link.id.replace('nav-', '');
                window.location.hash = page;
            };
        });

        // Adiciona evento de fechar modal ao clicar fora
        receitaModal.addEventListener('click', function(event) {
          if (event.target === receitaModal) {
            // A fun√ß√£o de fechar est√° em receitas.js, precisamos garantir que ela exista
            if (typeof public_receitas_fecharModalReceita === 'function') {
                public_receitas_fecharModalReceita();
            }
          }
        });
    }

  </script>
</body>
</html>